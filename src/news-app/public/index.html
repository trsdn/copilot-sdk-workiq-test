<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Aggregator - Work IQ + Copilot SDK</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        h1 { font-size: 2.2rem; color: #fff; margin-bottom: 8px; }
        h1 span {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: #888; font-size: 1rem; }
        .controls { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 210, 255, 0.3);
        }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .filter-toggle {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 20px; background: #2a2a4a; border-radius: 8px;
        }
        .filter-toggle label { cursor: pointer; }
        .filter-input {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 15px; background: #2a2a4a; border-radius: 8px;
        }
        .filter-input label { font-size: 0.85rem; color: #888; }
        .filter-input input, .filter-input select {
            background: #1a1a2e; border: 1px solid #444; border-radius: 4px;
            color: #fff; padding: 6px 10px; font-size: 0.9rem; width: 70px;
        }
        .filter-input select { width: auto; }
        .status-panel {
            background: #1e1e3f; border: 1px solid #333; border-radius: 12px;
            padding: 20px; margin-bottom: 20px; display: none;
        }
        .status-panel.active { display: block; }
        .status-message { font-size: 1.1rem; color: #00d2ff; margin-bottom: 10px; }
        .live-output {
            background: #0d0d1a; border-radius: 8px; padding: 15px;
            max-height: 200px; overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace; font-size: 0.85rem;
            color: #888; white-space: pre-wrap; word-break: break-word;
        }
        .progress-bar { height: 4px; background: #333; border-radius: 2px; overflow: hidden; margin-top: 15px; }
        .progress-bar-fill {
            height: 100%; background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            width: 0%; transition: width 0.3s ease; animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .stats { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat { background: #2a2a4a; padding: 15px 25px; border-radius: 12px; text-align: center; }
        .stat-number { font-size: 1.8rem; font-weight: 700; color: #00d2ff; }
        .stat-label { font-size: 0.85rem; color: #888; margin-top: 3px; }
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .news-card {
            background: #1e1e3f; border-radius: 12px; padding: 18px;
            border: 1px solid #333; transition: all 0.3s ease;
        }
        .news-card:hover { transform: translateY(-3px); border-color: #00d2ff; box-shadow: 0 8px 25px rgba(0, 210, 255, 0.1); }
        .news-card.duplicate { border-left: 4px solid #ff9800; opacity: 0.7; }
        .news-card.hidden { display: none; }
        .news-source {
            display: inline-block; padding: 3px 8px; background: #3a7bd5;
            border-radius: 15px; font-size: 0.7rem; font-weight: 600;
            text-transform: uppercase; margin-bottom: 8px;
        }
        .news-card.duplicate .news-source { background: #ff9800; }
        .news-title { font-size: 1rem; font-weight: 600; color: #fff; margin-bottom: 8px; line-height: 1.4; }
        .news-title a { color: #fff; text-decoration: none; }
        .news-title a:hover { color: #00d2ff; text-decoration: underline; }
        .news-meta { font-size: 0.8rem; color: #666; margin-bottom: 10px; }
        .news-meta a { color: #3a7bd5; text-decoration: none; }
        .news-meta a:hover { text-decoration: underline; }
        .news-summary { color: #a0a0a0; line-height: 1.5; font-size: 0.9rem; }
        .duplicate-badge {
            display: inline-block; padding: 2px 6px; background: #ff9800; color: #000;
            border-radius: 4px; font-size: 0.65rem; font-weight: 600; margin-left: 8px;
        }
        .duplicate-groups { margin-bottom: 20px; }
        .duplicate-group {
            background: #2a2a4a; border-radius: 8px; padding: 12px;
            margin-bottom: 10px; border-left: 4px solid #ff9800;
        }
        .duplicate-group h3 { color: #ff9800; font-size: 0.9rem; margin-bottom: 5px; }
        .duplicate-group p { color: #888; font-size: 0.85rem; }
        .empty-state { text-align: center; padding: 50px; color: #666; }
        .empty-state h2 { margin-bottom: 8px; color: #888; }
        .error { background: #ff4444; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        #results { display: none; }
        #results.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∞ <span>News Aggregator</span></h1>
            <p class="subtitle">Powered by Work IQ + Copilot SDK</p>
        </header>
        <div class="controls">
            <button class="btn-primary" id="fetchNews" onclick="fetchNewsStream()">üîÑ Fetch News</button>
            <div class="filter-input">
                <label>Last</label>
                <select id="daysFilter">
                    <option value="1">1 day</option>
                    <option value="3" selected>3 days</option>
                    <option value="7">7 days</option>
                    <option value="14">14 days</option>
                    <option value="30">30 days</option>
                </select>
            </div>
            <div class="filter-input">
                <label>Max</label>
                <input type="number" id="maxNews" value="30" min="5" max="100">
                <label>items</label>
            </div>
            <div class="filter-toggle">
                <input type="checkbox" id="hideDuplicates" onchange="toggleDuplicates()">
                <label for="hideDuplicates">Hide Duplicates</label>
            </div>
        </div>
        <div class="status-panel" id="statusPanel">
            <div class="status-message" id="statusMessage">Starting...</div>
            <div class="live-output" id="liveOutput"></div>
            <div class="progress-bar"><div class="progress-bar-fill" id="progressFill"></div></div>
        </div>
        <div id="error"></div>
        <div id="results">
            <div class="stats" id="stats"></div>
            <div class="duplicate-groups" id="duplicateGroups"></div>
            <div class="news-grid" id="newsGrid"></div>
        </div>
        <div class="empty-state" id="emptyState">
            <h2>No news loaded yet</h2>
            <p>Click "Fetch News from Inbox" to aggregate your newsletters</p>
        </div>
    </div>
    <script>
        let newsData = null;
        function fetchNewsStream() {
            const btn = document.getElementById('fetchNews');
            const statusPanel = document.getElementById('statusPanel');
            const statusMessage = document.getElementById('statusMessage');
            const liveOutput = document.getElementById('liveOutput');
            const progressFill = document.getElementById('progressFill');
            const results = document.getElementById('results');
            const emptyState = document.getElementById('emptyState');
            const errorDiv = document.getElementById('error');
            
            // Get filter values
            const days = document.getElementById('daysFilter').value;
            const maxNews = document.getElementById('maxNews').value;
            
            btn.disabled = true;
            btn.textContent = '‚è≥ Fetching...';
            statusPanel.classList.add('active');
            results.classList.remove('active');
            emptyState.style.display = 'none';
            errorDiv.innerHTML = '';
            liveOutput.textContent = '';
            progressFill.style.width = '30%';
            
            // Pass filters as query params
            const eventSource = new EventSource(`/api/news-stream?days=${days}&max=${maxNews}`);
            let rawOutput = '';
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'status':
                        statusMessage.textContent = data.message;
                        if (data.message.includes('Querying')) progressFill.style.width = '50%';
                        if (data.message.includes('Got data')) progressFill.style.width = '70%';
                        if (data.message.includes('Processing')) progressFill.style.width = '90%';
                        break;
                    case 'chunk':
                        rawOutput += data.content;
                        liveOutput.textContent = rawOutput.slice(-500);
                        liveOutput.scrollTop = liveOutput.scrollHeight;
                        break;
                    case 'complete':
                        progressFill.style.width = '100%';
                        eventSource.close();
                        setTimeout(() => {
                            statusPanel.classList.remove('active');
                            newsData = data.data;
                            renderNews(data.data);
                            results.classList.add('active');
                            btn.disabled = false;
                            btn.textContent = 'üîÑ Fetch News from Inbox';
                        }, 500);
                        break;
                    case 'error':
                        eventSource.close();
                        errorDiv.innerHTML = `<div class="error">‚ùå ${data.message}</div>`;
                        statusPanel.classList.remove('active');
                        emptyState.style.display = 'block';
                        btn.disabled = false;
                        btn.textContent = 'üîÑ Fetch News from Inbox';
                        break;
                }
            };
            eventSource.onerror = () => {
                eventSource.close();
                errorDiv.innerHTML = '<div class="error">‚ùå Connection lost</div>';
                statusPanel.classList.remove('active');
                btn.disabled = false;
                btn.textContent = 'üîÑ Fetch News';
            };
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'Unknown date';
            try {
                const d = new Date(dateStr);
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch { return dateStr; }
        }
        
        function renderNews(data) {
            const statsDiv = document.getElementById('stats');
            const duplicateGroupsDiv = document.getElementById('duplicateGroups');
            const newsGrid = document.getElementById('newsGrid');
            const news = data.news || [];
            const duplicateGroups = data.duplicateGroups || [];
            const totalNews = news.length;
            const duplicateCount = news.filter(n => n.isDuplicate).length;
            const uniqueCount = totalNews - duplicateCount;
            const sources = [...new Set(news.map(n => n.source || n.sender))].length;
            statsDiv.innerHTML = `
                <div class="stat"><div class="stat-number">${totalNews}</div><div class="stat-label">News Items</div></div>
                <div class="stat"><div class="stat-number">${uniqueCount}</div><div class="stat-label">Unique</div></div>
                <div class="stat"><div class="stat-number">${duplicateCount}</div><div class="stat-label">Duplicates</div></div>
                <div class="stat"><div class="stat-number">${sources}</div><div class="stat-label">Sources</div></div>
            `;
            if (duplicateGroups.length > 0) {
                duplicateGroupsDiv.innerHTML = `
                    <h2 style="margin-bottom: 12px; color: #ff9800; font-size: 1rem;">‚ö†Ô∏è Duplicate Stories</h2>
                    ${duplicateGroups.map(group => `
                        <div class="duplicate-group">
                            <h3>${(group.topic || '').substring(0, 60)}...</h3>
                            <p>${group.items.length} sources</p>
                        </div>
                    `).join('')}
                `;
            } else { duplicateGroupsDiv.innerHTML = ''; }
            
            newsGrid.innerHTML = news.map((item, idx) => {
                const title = item.subject || item.title || 'Untitled';
                const emailUrl = item.emailUrl || item.url || item.link;
                const titleHtml = emailUrl 
                    ? `<a href="${emailUrl}" target="_blank" rel="noopener">${title}</a>`
                    : title;
                const emailLinkHtml = emailUrl
                    ? `<a href="${emailUrl}" target="_blank" rel="noopener">üìß Open Email</a>`
                    : '';
                    
                return `
                    <div class="news-card ${item.isDuplicate ? 'duplicate' : ''}" data-duplicate="${item.isDuplicate || false}">
                        <span class="news-source">${item.source || item.sender || 'News'}</span>
                        ${item.isDuplicate ? '<span class="duplicate-badge">DUP</span>' : ''}
                        <h3 class="news-title">${titleHtml}</h3>
                        <p class="news-meta">üìÖ ${formatDate(item.date)} ${emailLinkHtml}</p>
                        <p class="news-summary">${item.summary || ''}</p>
                    </div>
                `;
            }).join('');
            
            if (news.length === 0 && data.rawResponse) {
                newsGrid.innerHTML = `
                    <div class="news-card" style="grid-column: 1 / -1;">
                        <h3 class="news-title">Raw Response</h3>
                        <p class="news-summary" style="white-space: pre-wrap; font-size: 0.8rem;">${data.rawResponse}</p>
                    </div>
                `;
            }
        }
        function toggleDuplicates() {
            const hide = document.getElementById('hideDuplicates').checked;
            document.querySelectorAll('.news-card[data-duplicate="true"]').forEach(card => {
                card.classList.toggle('hidden', hide);
            });
        }
    </script>
</body>
</html>
